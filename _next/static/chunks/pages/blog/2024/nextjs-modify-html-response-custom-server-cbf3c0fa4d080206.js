(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[738],{1930:function(e,n,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/blog/2024/nextjs-modify-html-response-custom-server",function(){return s(8423)}])},5990:function(e){e.exports={externalIcon:"ExternalLink_externalIcon__gmpoW"}},8423:function(e,n,s){"use strict";s.r(n),s.d(n,{default:function(){return a}});var t=s(5893);s(7294);var r=s(9739),o=s(8143),i=s(5485);function a(){return(0,t.jsxs)(r.Z,{title:"Modify the HTML response from a Next.js custom server",createdAt:"2024-06-11T11:38:28.287Z",tags:"technology",description:"With the Next.js custom server, we will study how to modify the HTML response for routes. This can be used for injecting custom scripts based on user-agent or to add the csrf meta tag",children:[(0,t.jsxs)("p",{children:[(0,t.jsx)(i.Z,{href:"https://nextjs.org",text:"Next.js",externalIcon:!0})," ","is a popular framework for creating React.js frontend applications. It is especially useful for improving SEO for website while keeping SPA like application architecture."]}),(0,t.jsx)("h4",{children:"Problem"}),(0,t.jsxs)("p",{children:["Next.js offers a custom server implementation. This is often required for custom handling of incoming requests. This could be redirecting based on the user session or CSRF implementation. Sometimes you may want to modify the HTML responses for a Next.js rendered page. This could be especially useful for injecting scripts or meta tags based on headers. Something like this is requested in"," ",(0,t.jsx)(i.Z,{href:"https://github.com/vercel/next.js/discussions/57042",text:"issue",externalIcon:!0}),"."]}),(0,t.jsx)("h4",{children:"Solution"}),(0,t.jsxs)("p",{children:["First, you need to disable ",(0,t.jsx)("code",{children:"compression"})," in your Next.js project config. Compression is often already performed by cloud computing frontend servers or an external service like Cloudflare."]}),(0,t.jsx)("p",{children:"In this example, we are using an Express.js based custom server. Here we are modifying all HTML output(s) and injecting a custom meta tag, when suitable."}),(0,t.jsx)(o.Z,{language:"javascript",children:"import next from 'next';\nimport Express from 'express';\n\nconst server = express();\nconst app = next({ dev: true });\nconst handle = app.getRequestHandler();\n\nserver.all('*', async (req, res) => {\n  const isHTMLRequest =\n    req.method === 'GET' &&\n    req.accepts(['json', 'html']) === 'html' &&\n    !req.path.includes('/_next/');\n\n  if (isHTMLRequest) {\n    // get tag value\n    const value = await getMetaTagValue();\n\n    const _resEnd = res.end.bind(res);\n    res.end = function (payload) {\n      if (!payload) return _resEnd(payload);\n\n      const modifiedPayload = payload.replace(\n        '</head>',\n        `<meta name=\"custom-data\" content=\"${value}\" /></head>`,\n      );\n\n      // ensure that correct content length\n      // is set, so content is not trimmed\n      res.setHeader('Content-Length', Buffer.byteLength(modifiedPayload));\n\n      return _resEnd(modifiedPayload);\n    };\n  }\n\n  return handle(req, res);\n});\n\napp\n  .prepare()\n  .then(() => {\n    server.listen(3000);\n  })\n  .catch((error: Error) => {\n    console.error(error);\n  });"}),(0,t.jsx)("p",{children:"Also notice that we are resetting content length, so modified HTML content is not trimmed."})]})}},8143:function(e,n,s){"use strict";s.d(n,{Z:function(){return i}});var t=s(5893);s(7294);var r=s(4767),o=s(545);function i(e){let{language:n,children:s}=e;return(0,t.jsx)(r.Z,{language:n,style:o.lf,showLineNumbers:!0,children:s})}},5485:function(e,n,s){"use strict";var t=s(5893);s(7294);var r=s(3967),o=s(4066),i=s(5990);n.Z=function(e){let{children:n,className:s,href:a,text:c,externalIcon:l}=e;return(0,t.jsxs)("a",{className:r(s),href:a,target:"_blank",children:[n,c&&(0,t.jsx)("span",{className:"me-1",children:c}),l&&(0,t.jsx)(o.CkN,{className:i.externalIcon})]})}},9739:function(e,n,s){"use strict";s.d(n,{Z:function(){return p}});var t=s(5893),r=s(7294),o=s(2962),i=s(3944),a=s(1163),c=s(7564),l=s(1832),d=s(2891),u=s(8353);function h(e){let{date:n}=e;return(0,t.jsxs)("span",{children:[(0,t.jsx)("span",{className:"badge bg-info me-2 p-2 text-uppercase",children:"Posted on "}),(0,t.jsx)("span",{className:"badge bg-dark me-2 p-2",children:new Date(n).toDateString()})]})}var m=s(4066);function p(e){let{children:n,title:s,description:p,createdAt:f}=e,{push:x,asPath:j}=(0,a.useRouter)(),g=r.useRef(null),b=r.useRef(null),y=e=>{e.current&&e.current.scrollIntoView({behavior:"smooth",block:"start"})};return s=d(s),(0,t.jsxs)(u.Z,{title:s,children:[(0,t.jsx)(o.dX,{url:"https://sushantdhiman.com".concat(j),type:"BlogPosting",title:s,description:p,datePublished:f,authorName:"Sushant Dhiman"}),(0,t.jsxs)("div",{ref:b,children:[(0,t.jsx)("span",{className:"float-start",children:(0,t.jsx)(h,{date:f})}),(0,t.jsx)("span",{className:"float-end",children:(0,t.jsxs)(c.Z,{children:[(0,t.jsx)(l.Z,{onClick:()=>x("/blog"),size:"sm",color:"primary",children:(0,t.jsx)(m.x_l,{})}),(0,t.jsx)(l.Z,{onClick:()=>y(g),size:"sm",color:"primary",children:(0,t.jsx)(m.NWQ,{})})]})}),(0,t.jsx)("span",{className:"clearfix"})]}),(0,t.jsx)("br",{}),n,(0,t.jsx)("br",{ref:g}),(0,t.jsx)(l.Z,{onClick:()=>y(b),color:"primary",size:"sm",children:(0,t.jsx)(m.ZTc,{})}),(0,t.jsx)("br",{}),(0,t.jsx)("br",{}),(0,t.jsx)(i.qw,{shortname:"sushantdhiman-github-io",config:{title:s}})]})}},8353:function(e,n,s){"use strict";s.d(n,{Z:function(){return c}});var t=s(5893);s(7294);var r=s(9008),o=s(2891),i=s(3758),a=s(3359);function c(e){let{title:n,headTitle:s,children:c}=e;return(0,t.jsxs)(i.Z,{className:"justify-content-center",children:[(0,t.jsx)(r,{children:(0,t.jsx)("title",{children:"".concat(o(s||n)," | Sushant Dhiman")})}),(0,t.jsxs)(a.Z,{md:"8",lg:"10",children:[n&&(0,t.jsx)("h1",{className:"my-5 text-center text-primary",children:o(n)}),c]})]})}}},function(e){e.O(0,[489,545,888,774,179],function(){return e(e.s=1930)}),_N_E=e.O()}]);