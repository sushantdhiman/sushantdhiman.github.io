(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[654],{2758:(e,s,n)=>{"use strict";n.d(s,{A:()=>l});var i=n(7876);n(4232);var a=n(9841),r=n(9084);function l(e){let{language:s,children:n}=e;return(0,i.jsx)(a.A,{language:s,style:r.KQ,showLineNumbers:!0,children:n})}},2900:(e,s,n)=>{"use strict";n.d(s,{A:()=>t});var i=n(7876);n(4232);var a=n(2870),r=n(5483),l=n.n(r);let t=function(e){let{children:s,className:n,href:r,text:t,externalIcon:o}=e;return(0,i.jsxs)("a",{className:n,href:r,target:"_blank",children:[s,t&&(0,i.jsx)("span",{className:"me-1",children:t}),o&&(0,i.jsx)(a.EQc,{className:l().externalIcon})]})}},4088:(e,s,n)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/blog/2021/how-to-backup-imap-emails",function(){return n(8291)}])},5483:e=>{e.exports={externalIcon:"ExternalLink_externalIcon__gmpoW"}},6243:(e,s,n)=>{"use strict";n.d(s,{A:()=>x});var i=n(7876),a=n(4232),r=n(2867),l=n(3606),t=n(9099),o=n(9647),c=n(5554),d=n(9079),h=n(8280);function m(e){let{date:s}=e;return(0,i.jsxs)("span",{children:[(0,i.jsx)("span",{className:"badge bg-info me-2 p-2 text-uppercase",children:"Posted on "}),(0,i.jsx)("span",{className:"badge bg-dark me-2 p-2",children:new Date(s).toDateString()})]})}var u=n(2870),p=n(9549);function x(e){let{children:s,title:n,description:x,createdAt:g}=e,{push:j,asPath:f}=(0,t.useRouter)(),b=a.useRef(null),y=a.useRef(null),w=e=>{e.current&&e.current.scrollIntoView({behavior:"smooth",block:"start"})};return n=(0,d.A)(n),(0,i.jsxs)(h.A,{title:n,children:[(0,i.jsx)(r.dp,{images:[],url:"https://sushantdhiman.com".concat(f),type:"BlogPosting",title:n,description:x,datePublished:g,authorName:"Sushant Dhiman"}),(0,i.jsxs)("div",{ref:y,children:[(0,i.jsx)("span",{className:"float-start",children:(0,i.jsx)(m,{date:g})}),(0,i.jsx)("span",{className:"float-end",children:(0,i.jsxs)(o.A,{children:[(0,i.jsx)(c.A,{onClick:()=>j("/blog"),size:"sm",color:"primary",children:(0,i.jsx)(u.QVr,{})}),(0,i.jsx)(c.A,{onClick:()=>w(b),size:"sm",color:"primary",children:(0,i.jsx)(u.$TP,{})})]})}),(0,i.jsx)("span",{className:"clearfix"})]}),(0,i.jsx)("br",{}),s,(0,i.jsx)("br",{ref:b}),(0,i.jsx)(c.A,{onClick:()=>w(y),color:"primary",size:"sm",children:(0,i.jsx)(u.uCC,{})}),(0,i.jsx)("br",{}),(0,i.jsx)("br",{}),(0,i.jsx)(l.Mq,{shortname:p.W,config:{title:n}})]})}},8280:(e,s,n)=>{"use strict";n.d(s,{A:()=>c});var i=n(7876);n(4232);var a=n(7328),r=n.n(a),l=n(9079),t=n(672),o=n(2290);function c(e){let{title:s,headTitle:n,children:a}=e;return(0,i.jsxs)(t.A,{className:"justify-content-center",children:[(0,i.jsx)(r(),{children:(0,i.jsx)("title",{children:"".concat((0,l.A)(n||s)," | Sushant Dhiman")})}),(0,i.jsxs)(o.A,{md:"8",lg:"10",children:[s&&(0,i.jsx)("h1",{className:"my-5 text-center text-primary",children:(0,l.A)(s)}),a]})]})}},8291:(e,s,n)=>{"use strict";n.r(s),n.d(s,{default:()=>t});var i=n(7876);n(4232);var a=n(2758),r=n(6243),l=n(2900);function t(){return(0,i.jsxs)(r.A,{title:"how to backup imap emails",createdAt:"2021-02-26T13:44:28.000Z",tags:"technology",description:"How to backup IMAP email using rsync and mbsync",children:[(0,i.jsx)("h4",{children:"Preface"}),(0,i.jsx)("p",{children:"Recently I bought some space for email hosting. For personal emails I use Gmail & Outlook, so I never thought about keeping backup of my emails. But with this provider I wanted to keep off-site backup of my new email accounts."}),(0,i.jsxs)("p",{children:["I researched many CLI based tools for this. I think"," ",(0,i.jsx)(l.A,{href:"https://isync.sourceforge.io/mbsync.html",text:"mbsync",externalIcon:!0})," ","works best for this. It supports bidirectional and one-way sync, which is required for backup and restore."]}),(0,i.jsxs)("p",{children:["Our goal here is to download emails in ",(0,i.jsx)("code",{children:"Maildir"})," format and then backup them using ",(0,i.jsx)("code",{children:"rclone"}),"."]}),(0,i.jsx)("h4",{children:"Configuring mbsync"}),(0,i.jsxs)("p",{children:["By default ",(0,i.jsx)("code",{children:"mbsync"})," uses ",(0,i.jsx)("code",{children:"~/.mbsyncrc"})," file as default configuration, but it supports custom config with"," ",(0,i.jsx)("code",{children:"-c"})," argument. We are going to use this option, so we can switch between different configuration files."]}),(0,i.jsx)("p",{children:"Here is a sample configuration file for pulling emails to a local directory"}),(0,i.jsx)(a.A,{language:"bash",children:'# .mbsyncrc_pull\n# global options\nCreate Slave\nExpunge Slave\nSync Pull\n# required when moving emails with email client\nCopyArrivalDate yes\n\nIMAPAccount email-me\nHost mail.email.com\nUser me@email.com\nPassCmd "gpg -q --for-your-eyes-only --no-tty -d email.pass"\nSSLType IMAPS\nCertificateFile /etc/ssl/certs/ca-certificates.crt\n\n# mappings\nIMAPStore remote-email-me\nAccount email-me\n\n# local storage we\'ll be using. Note the trailing slash at the end of the Path\nMaildirStore local-email-me\nPath ~/imap-backup/mails/email/me/\nInbox ~/imap-backup/mails/email/me/Inbox\nSubFolders Verbatim\n\n# channels\nChannel sync-email-me\nMaster :remote-email-me:\nSlave :local-email-me:\nPatterns * !Junk !Trash\nSyncState *'}),(0,i.jsx)("h4",{children:"GPG for encrypting/decrypting passwords"}),(0,i.jsx)("p",{children:"We don't want to keep plaintext passwords in the configuration file. We can use GPG to encrypt/decrypt passwords in our local system."}),(0,i.jsx)("p",{children:"You can use the following command to encrypt password :-"}),(0,i.jsx)(a.A,{language:"bash",children:'echo "password" | gpg --symmetric --armor > secret.pass'}),(0,i.jsx)("p",{children:"It will ask for a passphrase."}),(0,i.jsx)("p",{children:"Then you can use the following command to decrypt this file :-"}),(0,i.jsx)(a.A,{language:"bash",children:"gpg -q --for-your-eyes-only --no-tty -d secret.pass"}),(0,i.jsx)("p",{children:"You will be prompted for passphrase which was entered when encrypting this file."}),(0,i.jsx)("h4",{children:"Configuration details"}),(0,i.jsxs)("p",{children:["This configuration is specifically for pulling emails to local disk."," ",(0,i.jsx)("code",{children:"Sync Pull"})," indicates we want to pull emails from our"," ",(0,i.jsx)("code",{children:"IMAPStore"})," to ",(0,i.jsx)("code",{children:"MaildirStore"}),"."]}),(0,i.jsxs)("p",{children:[(0,i.jsx)("code",{children:"CopyArrivalDate"})," is here to ensure correct dates are used when moving emails with email clients."]}),(0,i.jsxs)("p",{children:[(0,i.jsx)("code",{children:"IMAPAccount"})," defines remote IMAP account. Notice"," ",(0,i.jsx)("code",{children:"PassCmd"})," is using GPG decryption that was explained in last section."]}),(0,i.jsxs)("p",{children:[(0,i.jsx)("code",{children:"IMAPStore/Account"})," mapping links an email account with IMAP store. ",(0,i.jsx)("code",{children:"MaildirStore"})," is used for defining local disk path where ",(0,i.jsx)("code",{children:"Maildir"})," will be stored."]}),(0,i.jsxs)("p",{children:["Lastly we have channels, ",(0,i.jsx)("code",{children:"Channel"})," is used to define which direction emails will flow. Because of ",(0,i.jsx)("code",{children:"Sync Pull"})," mails will go from ",(0,i.jsx)("code",{children:"Master"})," to ",(0,i.jsx)("code",{children:"Slave"}),"."]}),(0,i.jsx)("p",{children:"Once you have configured your email account, emails can be downloaded using the following command :-"}),(0,i.jsx)(a.A,{language:"bash",children:"mbsync -aq -c .mbsyncrc_pull"}),(0,i.jsx)("h4",{children:"Backup using rclone"}),(0,i.jsxs)("p",{children:[(0,i.jsx)(l.A,{href:"https://rclone.org/",text:"mbsync",externalIcon:!0})," ","is a good option for CLI based backups. We have downloaded emails in a directory, we just need to upload it as a zip file."]}),(0,i.jsxs)("p",{children:["Configuring ",(0,i.jsx)("code",{children:"rclone"})," to use your choice of backend is explained in details on their website."]}),(0,i.jsxs)("p",{children:["In ",(0,i.jsx)("code",{children:"Maildir"})," there are some additional files which we don't need in zip archive. Use the following command for preparing zip :-"]}),(0,i.jsx)(a.A,{language:"bash",children:"zip -q -r emails.zip mails -x '*/*.mbsyncstate' '*/*.uidvalidity'"}),(0,i.jsx)("p",{children:"Finally move zip file to remote location with the following command :-"}),(0,i.jsx)(a.A,{language:"bash",children:"rclone move emails.zip remote:<remote_backup_path>"}),(0,i.jsx)("h4",{children:"Conclusion"}),(0,i.jsxs)("p",{children:["Here we have discussed how to take IMAP backup using ",(0,i.jsx)("code",{children:"mbsync"})," ","and ",(0,i.jsx)("code",{children:"rclone"}),". Similarly ",(0,i.jsx)("code",{children:"mbsync"})," can be used for restoring emails back to IMAP server. Readers should be able to figure that out. If I get some time in future I will try to write a post about restoring emails."]})]})}},9549:(e,s,n)=>{"use strict";n.d(s,{W:()=>i});let i="sushantdhiman-github-io"}},e=>{var s=s=>e(e.s=s);e.O(0,[800,141,84,636,593,792],()=>s(4088)),_N_E=e.O()}]);